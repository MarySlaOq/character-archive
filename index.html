<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Relationship builder</title>

    <!-- User data in files-->
    <script id="script" src="data.json"></script>

    <script src="utils.js"></script>
    <script src="secrets.js"></script>
    <script src="parser.js"></script>

    <!-- include firebase -->
    <script type="module"></script>

    <script src="database.js"></script>

    <script type="module" async>
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-analytics.js";
      import {
        getDatabase,
        ref,
        child,
        get,
      } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";
      import {
        getAuth,
        GoogleAuthProvider,
        signInWithPopup,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";

      var connection = false;
      var loaded;

      // Get the database info
      async function fetchAllDataBaseInfo(database, app) {
        popUpNotification("Connected to database successfully", 0);
        sleep(0).then(() => {
          // Get people
          const dbRef = ref(database);
          get(child(dbRef, `people`))
            .then((snapshot) => {
              if (snapshot.exists()) {
                data.people = snapshot.val();
                popUpNotification("People information loaded", 0);

                get(child(dbRef, `relations`)).then((snapshot) => {
                  if (snapshot.exists()) {
                    data.relations = { ...snapshot.val() };

                    popUpNotification("Character relations loaded", 0);

                    get(child(dbRef, `settings`)).then((snapshot) => {
                      if (snapshot.exists()) {
                        data.settings = { ...snapshot.val() };

                        popUpNotification("Character relations loaded", 0);

                        get(child(dbRef, `animals`)).then((snapshot) => {
                          if (snapshot.exists()) {
                            animals = { ...snapshot.val() };

                            popUpNotification("Animal information loaded", 0);

                            get(child(dbRef, `worlds`)).then((snapshot) => {
                              if (snapshot.exists()) {
                                for (const property in snapshot.val()) {
                                  const element = snapshot.val()[property];
                                  const dimData = {
                                    name: element.name,
                                    outline: element.outline,
                                    world: {
                                      divisions: element.divisions,
                                      maps: [],
                                    },
                                    characters: [],
                                    events: [],
                                    calendar: [],
                                  };

                                  data.dimensions.push(dimData);
                                }

                                popUpNotification(
                                  "Dimension information loaded",
                                  0
                                );

                                get(child(dbRef, `maps`)).then((snapshot) => {
                                  if (snapshot.exists()) {
                                    for (const property in snapshot.val()) {
                                      const element = snapshot.val()[property];

                                      data.dimensions.find(
                                        (d) => d.name == property
                                      ).world.maps = element;
                                    }

                                    popUpNotification(
                                      "Map information loaded",
                                      0
                                    );

                                    get(child(dbRef, `characters`)).then(
                                      (snapshot) => {
                                        if (snapshot.exists()) {
                                          for (const property in snapshot.val()) {
                                            const element =
                                              snapshot.val()[property];

                                            data.dimensions.find(
                                              (d) => d.name == property
                                            ).characters = element;
                                          }

                                          popUpNotification(
                                            "Character information loaded",
                                            0
                                          );

                                          parse();
                                        } else {
                                          popUpNotification(
                                            "Could not load characters",
                                            1
                                          );
                                        }
                                      }
                                    );
                                  } else {
                                    popUpNotification("Could not load maps", 1);
                                  }
                                });
                              } else {
                                popUpNotification(
                                  "Could not load dimensions",
                                  1
                                );
                              }
                            });
                          } else {
                            popUpNotification("Could not load animals", 1);
                          }
                        });
                      } else {
                        popUpNotification("Could not load settings", 1);
                      }
                    });
                  } else {
                    popUpNotification("Could not load relations", 1);
                  }
                });

                loaded = true;
              } else {
                popUpNotification("Could not load people", 1);
              }
            })
            .catch((error) => {
              console.error(error);
            });
        });
      }

      let auth;
      let provider;
      try {
        const app = initializeApp(firebaseConfig);
        connection = true;

        const analytics = getAnalytics(app);
        auth = getAuth(app);
        provider = new GoogleAuthProvider();

        const database = getDatabase(app);
        fetchAllDataBaseInfo(database, app);
      } catch (err) {
        console.error(err);
        popUpNotification("Could not connect to database", 1);
      }

      function authFunction() {
        if (document.getElementById("login").innerText == "Sign out") {
          signOut(auth)
            .then(() => {
              myuser = undefined;
              localStorage.removeItem("ca-user-account");
              document.getElementById("username").innerText =
                "Browsing as guest";
              document.getElementById("userimg").src = "resources/alexia.jpg";
              document.getElementById("login").innerText = "Login with google";
              document.getElementById("login").className = "button-6";
            })
            .catch((error) => {
              popUpNotification("Sign out failed", 1);
            });
        } else {
          signInWithPopup(auth, provider)
            .then((result) => {
              // This gives you a Google Access Token. You can use it to access the Google API.
              const credential =
                GoogleAuthProvider.credentialFromResult(result);
              const token = credential.accessToken;

              const user = result.user;
              saveUserData(user);
              console.log(user);

              popUpNotification("Logged in as " + user.displayName, 0);
            })
            .catch((error) => {
              popUpNotification("Google login failed", 1);
            });
        }
      }

      document.getElementById("login").onclick = authFunction;
    </script>

    <!-- include jquery -->

    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
      crossorigin="anonymous"
    ></script>

    <script src="cycle.js"></script>

    <link rel="stylesheet" href="style.css" />

    <script src="lines/leader-line.min.js"></script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <script>
      function close_popup() {
        document.getElementById("blinds").style.opacity = 0;
        document.getElementById("blinds").style.zIndex = -200;

        document.getElementById("popup").style.opacity = 0;
        document.getElementById("popup").style.zIndex = -100;
      }
    </script>
  </head>
  <body>
    <h1 id="title"></h1>
    <br />

    <!-- User panel -->
    <div class="container2">
      <div class="container3 relation">
        <img id="userimg" class="profile" src="resources/alexia.jpg" alt="" />
        <p id="username" class="m10"><b>Browsing as guest</b></p>
      </div>
      <button id="login" class="button-6">Login with google</button>
    </div>

    <br />
    <a href="about.html">About the application</a>
    <p>Click on the tabs to change dimension</p>
    <p>Drag characters with right click to move them around</p>

    <div id="tags" class="tab"></div>

    <div id="worlds"></div>

    <div class="loader" id="loader"></div>

    <!-- POP UPs -->

    <div class="map-popup" id="map-popup">
      <div id="header">
        <h2 id="location">Location</h2>
        <span id="division-type">type</span>
      </div>
      <p id="description">
        Lorem ipsum, dolor sit amet consectetur adipisicing elit.
      </p>
    </div>

    <div id="blinds"></div>
    <div class="popup" id="popup">
      <div class="container2">
        <div class="container2">
          <h1 id="name">Testing name</h1>
          <img
            class="icon"
            src="https://upload.wikimedia.org/wikipedia/commons/0/08/Pinterest-logo.png"
            id="pinterest"
          />
          <img
            class="icon"
            src="https://upload.wikimedia.org/wikipedia/commons/1/19/Spotify_logo_without_text.svg"
            id="spotify"
          />
        </div>
        <div>
          <button onclick="previous_popup()" class="close"><</button>
          <button onclick="next_popup()" class="close">></button>
          <button onclick="close_popup()" class="close">X</button>
        </div>
      </div>
      <p id="fullname">Fullname here!</p>
      <div class="container">
        <div>
          <h2>Background</h2>
          <p id="outline">
            Lorem ipsum dolor sit amet consectetur adipisicing elit.
          </p>
          <h2>Personality</h2>
          <p id="personality">
            Lorem ipsum dolor sit amet consectetur adipisicing elit. Culpa natus
            possimus minima repudiandae assumenda voluptas dicta facere
          </p>

          <h2>Traits</h2>
          <div id="traits">
            <p><b>Species</b>: <span id="species">test</span></p>
            <p><b>Age</b>: <span id="age">test</span></p>
            <p><b>Gender</b>: <span id="gender">test</span></p>
            <p><b>Occupation</b>: <span id="occupation">test</span></p>
            <p><b>Height</b>: <span id="height">test</span></p>
            <p><b>Weight</b>: <span id="weight">test</span></p>
            <p><b>Blood type</b>: <span id="bloodtype">test</span></p>
            <p><b>Birth date</b>: <span id="birthdate">test</span></p>
            <p><b>Birth place</b>: <span id="birthplace">test</span></p>
          </div>

          <h2>Preferences</h2>
          <div>
            <h4>Likes</h4>
            <ul id="likes">
              <li>One</li>
              <li>Two</li>
              <li>Three</li>
            </ul>
            <h4>Hates</h4>
            <ul id="hates">
              <li>One</li>
              <li>Two</li>
              <li>Three</li>
            </ul>
          </div>

          <h2>Relations</h2>
          <div id="relations">
            <p class="relation">Related to Character: Friends</p>
            <p class="relation">Related to Other Character: Siblings</p>
            <p class="relation">Related to Yet Another Character: Child</p>
          </div>

          <h2>Creators</h2>
          <div id="creators">
            <p><b>MarySlaOq</b> <a href="www.twitter.com">Twitter</a></p>
          </div>
        </div>
        <div>
          <img id="image" src="../resources/saloman.png" alt="" srcset="" />

          <div>
            <h2>Notes</h2>
            <p id="notes"></p>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
