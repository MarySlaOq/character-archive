<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Relationship builder</title>

    <!-- User data in files-->
    <script id="script" src="data.json"></script>

    <script src="secrets.js"></script>
    <script src="utils.js"></script>
    <script src="admin.js"></script>

    <!-- include firebase -->

    <script type="module" async>
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-analytics.js";
      import {
        getDatabase,
        ref,
        child,
        get,
        set,
        update,
      } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";
      import {
        getAuth,
        GoogleAuthProvider,
        signInWithPopup,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";

      var connection = false;
      var loaded;

      // Get the database info
      async function fetchAllDataBaseInfo(database, app) {
        popUpNotification("Connected to database successfully", 0);
        sleep(0).then(() => {

          // Get people
          const dbRef = ref(database);

          //get all
          get(child(dbRef, `/`)).then((snapshot) => {
            globalThis.dataAll = snapshot.val();

            console.log('Database loaded successfully.');
          }, (error) => {});

          get(child(dbRef, `people`))
            .then((snapshot) => {
              if (snapshot.exists()) {
                data.people = {...snapshot.val()};
                popUpNotification("People information loaded", 0);

                get(child(dbRef, `applications`)).then((snapshot) => {
                  if (snapshot.exists()) {
                    data.applications = snapshot.val();
                  }
                });

                get(child(dbRef, `relations`)).then((snapshot) => {
                  if (snapshot.exists()) {
                    data.relations = { ...snapshot.val() };

                    popUpNotification("Character relations loaded", 0);

                    get(child(dbRef, `settings`)).then((snapshot) => {
                      if (snapshot.exists()) {
                        data.settings = { ...snapshot.val() };

                        popUpNotification("Character relations loaded", 0);

                        get(child(dbRef, `animals`)).then((snapshot) => {
                          if (snapshot.exists()) {
                            animals = { ...snapshot.val() };

                            popUpNotification("Animal information loaded", 0);

                            get(child(dbRef, `worlds`)).then((snapshot) => {
                              if (snapshot.exists()) {
                                for (const property in snapshot.val()) {
                                  const element = snapshot.val()[property];
                                  const dimData = {
                                    name: element.name,
                                    outline: element.outline,
                                    world: {
                                      divisions: element.divisions,
                                      maps: [],
                                    },
                                    characters: [],
                                  };

                                  if (element.divisions == undefined)
                                    dimData.world = undefined;

                                  data.dimensions.push(dimData);
                                }

                                popUpNotification(
                                  "Dimension information loaded",
                                  0
                                );

                                get(child(dbRef, `maps`)).then((snapshot) => {
                                  if (snapshot.exists()) {
                                    for (const property in snapshot.val()) {
                                      const element = snapshot.val()[property];

                                      data.dimensions.find(
                                        (d) => d.name == property
                                      ).world.maps = element;
                                    }

                                    popUpNotification(
                                      "Map information loaded",
                                      0
                                    );

                                    get(child(dbRef, `characters`)).then(
                                      (snapshot) => {
                                        if (snapshot.exists()) {
                                          for (const property in snapshot.val()) {
                                            const element =
                                              snapshot.val()[property];

                                            data.dimensions.find(
                                              (d) => d.name == property
                                            ).characters = element;
                                          }

                                          popUpNotification(
                                            "Character information loaded",
                                            0
                                          );

                                          get(child(dbRef, `magic`)).then(
                                            (snapshot) => {
                                              if (snapshot.exists()) {
                                                for (const property in snapshot.val()) {
                                                  const element =
                                                    snapshot.val()[property];

                                                  data.dimensions.find(
                                                    (d) => d.name == property
                                                  ).magic = element;
                                                }

                                                popUpNotification(
                                                  "Magic information loaded",
                                                  0
                                                );

                                                parserFinishedCallback();
                                              } else {
                                                popUpNotification(
                                                  "Could not load characters",
                                                  1
                                                );
                                              }
                                            }
                                          );
                                        } else {
                                          popUpNotification(
                                            "Could not load characters",
                                            1
                                          );
                                        }
                                      }
                                    );
                                  } else {
                                    popUpNotification("Could not load maps", 1);
                                  }
                                });
                              } else {
                                popUpNotification(
                                  "Could not load dimensions",
                                  1
                                );
                              }
                            });
                          } else {
                            popUpNotification("Could not load animals", 1);
                          }
                        });
                      } else {
                        popUpNotification("Could not load settings", 1);
                      }
                    });
                  } else {
                    popUpNotification("Could not load relations", 1);
                  }
                });

                loaded = true;
              } else {
                popUpNotification("Could not load people", 1);
              }
            })
            .catch((error) => {
              console.error(error);
            });
        });
      }

      let auth;
      let provider;
      try {
        const app = initializeApp(firebaseConfig);
        connection = true;

        const analytics = getAnalytics(app);
        auth = getAuth(app);
        provider = new GoogleAuthProvider();

        const database = getDatabase(app);
        fetchAllDataBaseInfo(database, app);
      } catch (err) {
        console.error(err);
        popUpNotification("Could not connect to database", 1);
      }

      function authFunction() {
        if (document.getElementById("login").innerText == "Sign out") {
          signOut(auth)
            .then(() => {
              myuser = undefined;
              localStorage.removeItem("ca-user-account");
              document.getElementById("username").innerText =
                "Browsing as guest";
              document.getElementById("userimg").src = "resources/default.jpg";
              document.getElementById("login").innerText = "Login with google";
              document.getElementById("login").className = "button";

              window.location.reload();
            })
            .catch((error) => {
              popUpNotification("Sign out failed", 1);
            });
        } else {
          signInWithPopup(auth, provider)
            .then((result) => {
              // This gives you a Google Access Token. You can use it to access the Google API.
              const credential =
                GoogleAuthProvider.credentialFromResult(result);
              const token = credential.accessToken;

              const user = result.user;
              saveUserData(user);

              popUpNotification("Logged in as " + user.displayName, 0);

              window.location.reload();
            })
            .catch((error) => {
              popUpNotification("Google login failed", 1);
            });
        }
      }

      document.getElementById("login").onclick = authFunction;

      function updateDatabaseValue(newInformation, characterPath) {
        const updates = {};
        updates[characterPath] = newInformation;
        return update(ref(getDatabase()), updates);
      }

      function createDatabaseValue(newInformation, createCollection) {
        set(ref(getDatabase(), createCollection), newInformation);
      }

      globalThis.createDatabaseValue = createDatabaseValue;
      globalThis.updateDatabaseValue = updateDatabaseValue;

    </script>

    <!-- include jquery -->

    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
      crossorigin="anonymous"
    ></script>
    <script src="modals.js"></script>

    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>
  <body class="container is-fluid">
    <nav class="navbar" role="navigation" aria-label="main navigation">
      <div class="navbar-brand">
        <a
          role="button"
          class="navbar-burger"
          aria-label="menu"
          aria-expanded="false"
          data-target="navbarBasicExample"
        >
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>

      <div id="navbarBasicExample" class="navbar-menu">
        <div class="navbar-start">
          <a href="index.html" class="navbar-item"> Home </a>
    
          <div class="navbar-item has-dropdown is-hoverable">
            <a class="navbar-link"> Community </a>

            <div class="navbar-dropdown">
              <a event="checkCreatorValidity" data-target="modal-create" class="navbar-item js-modal-trigger"> <i class="fa-solid fa-pencil mr"></i> Apply to be a creator </a>
            </div>
          </div>

          <a href="about.html" class="navbar-item"> Documentation </a>

          <div class="navbar-item has-dropdown is-hoverable">
            <a class="navbar-link"> More </a>

            <div class="navbar-dropdown">
              <a
                target="_blank"
                href="https://github.com/MarySlaOq/character-archive"
                class="navbar-item"
              >
              <i class="fa-brands fa-github mr"></i> Source code
              </a>
              <a class="navbar-item"> About </a>
              <a class="navbar-item"> Contact </a>
              <hr class="navbar-divider" />
              <a
                target="_blank"
                href="https://github.com/MarySlaOq/character-archive/issues?q=is%3Aissue+is%3Aopen+sort%3Aupdated-desc"
                class="navbar-item"
              >
                Report an issue
              </a>
            </div>
          </div>
        </div>

        <!--<button onclick="addCharacterAttribute()">test</button>-->

        <div class="navbar-end">
          <div class="is-flex">

            <img
              id="userimg"
              class="is-rounded profile"
              src="resources/default.jpg"
              alt=""
            />
            <p id="username" class="m10 card-header-title">
              <b>Browsing as guest</b>
            </p>
          </div>
          <article id="access" style="margin: auto;">
            <div class="message-body" id="access-cont">
            </div>
          </article>
          <button id="login" class="button">Login with google</button>
        </div>
      </div>
    </nav>

    <br />

    <div id="controls">

      <h1 class="title">Admininstration panel</h1>

      <div id="creator applications">
        <div class="seperate">
          <h4 class="title is-4">Manage creator applications</h4>
          <article class="message is-primary is-small">
            <div class="message-body">
              Access level: Moderator+
            </div>
          </article>
        </div>

        <br>
        <div class="apps" id="application-list"></div>
      </div>

      <hr>

      <div class="columns">

        <div class="column">
          
          <div>
            <div class="seperate">
              <h4 class="title is-4">Manage creator accounts</h4>
              <article class="message is-warning is-small">
                <div class="message-body">
                  Access level: Admininstrator
                </div>
              </article>
            </div>
    
            <br>
            <div id="user-list"></div>
          </div>

        </div>

        <div class="column">
          
          <div>
            <div class="seperate">
              <h4 class="title is-4">Database backups</h4>
              <article class="message is-warning is-small">
                <div class="message-body">
                  Access level: Administrator
                </div>
              </article>
              
            </div>

            <div id="backups">
            </div>
          </div>

        </div>

      </div>
    </div>

    <div id="modify" class="modal">
      <div class="modal-background"></div>
    
      <div class="modal-content">
        <div class="box">
          <p id="edit-title" class="title">Change permissions</p>

          <article class="message is-warning">
            <div class="message-header">
              <p>Warning</p>
            </div>
            <div id="access-message" class="message-body">
              
            </div>
          </article>

          <div class="select">
            <select id="edit-access" onchange="messageChange()">
              <option value="0">Visitor</option>
              <option value="1">Creator</option>
              <option value="2">Moderator</option>
              <option value="3">Helper</option>
              <option value="4">Administrator</option>
            </select>
          </div>
          <br>
          <br>
          <div class="buttons">
            <button onclick="changeAccess()" class="button is-primary">Save</button>
          </div>
        </div>
      </div>
    

      <button class="modal-close is-large" aria-label="close"></button>
    </div>

  </body>

  <script src="blocker.js"></script>
</html>
